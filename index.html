<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Hostel Hub V2</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .tab-button {
            transition: all 0.2s ease-in-out;
            padding: 0.75rem 1.5rem;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280;
        }
        .tab-button.active {
            color: #1d4ed8;
            border-bottom-color: #1d4ed8;
        }
        .tab-content {
            display: none;
            padding: 1rem 0;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-500 mx-auto"></div>
            <p class="mt-4 text-gray-700">Connecting to Hostel Database...</p>
        </div>
    </div>

    <header class="mb-8">
        <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <i data-lucide="building-2" class="w-8 h-8 mr-2 text-indigo-600"></i>
                Smart Hostel Hub
            </h1>
            <div class="text-sm text-gray-500 hidden sm:block">
                Welcome, User <span id="user-id-display" class="font-mono bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs">Loading...</span>
            </div>
        </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Column 1: Mess Menu & Feedback (Refactored for 4 Meals) -->
        <section class="lg:col-span-2 card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i data-lucide="utensils" class="w-5 h-5 mr-2 text-green-600"></i>
                Mess Menu & Feedback (Today)
            </h2>

            <div class="border-b border-gray-200 mb-4 flex space-x-2 overflow-x-auto">
                <button class="tab-button active" data-meal="Breakfast">Breakfast</button>
                <button class="tab-button" data-meal="Lunch">Lunch</button>
                <button class="tab-button" data-meal="Snack">Snack</button>
                <button class="tab-button" data-meal="Dinner">Dinner</button>
            </div>

            <div id="menu-tabs-content">
                <!-- Content will be rendered here by JS -->
            </div>

            <h3 class="text-lg font-medium text-gray-700 mt-6 mb-3 border-t pt-4">Submit Meal Feedback</h3>
            <div id="feedback-form-container">
                <p class="text-gray-500 mb-4">Tell us how the meal was! (Select a meal type above first)</p>
                <div class="flex items-end space-x-3">
                    <select id="feedback-meal-type" class="p-2 border border-gray-300 rounded-lg w-1/3">
                        <option value="Breakfast">Breakfast</option>
                        <option value="Lunch">Lunch</option>
                        <option value="Snack">Snack</option>
                        <option value="Dinner">Dinner</option>
                    </select>
                    <input type="number" id="rating-input" min="1" max="5" placeholder="Rating (1-5)" class="p-2 border border-gray-300 rounded-lg w-1/3" required>
                    <button onclick="submitMessFeedback()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg w-1/3 transition-colors">Submit</button>
                </div>
                <p id="feedback-message" class="mt-2 text-sm text-center" style="display: none;"></p>
            </div>
        </section>

        <!-- Column 2: Notice Board (New Feature) -->
        <section class="card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i data-lucide="megaphone" class="w-5 h-5 mr-2 text-red-500"></i>
                Official Notice Board
            </h2>
            <div id="notices-container" class="space-y-4">
                <p class="text-gray-500">Loading announcements...</p>
            </div>
        </section>

        <!-- New Row for Logistics -->
        <section class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- Column 3: Leave/Gate Pass Request (New Feature) -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="send" class="w-5 h-5 mr-2 text-yellow-600"></i>
                    Request Leave / Gate Pass
                </h2>
                <form id="leave-request-form" class="space-y-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">End Date (Expected Return)</label>
                        <input type="date" id="end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="leave-reason" class="block text-sm font-medium text-gray-700">Reason for Leave</label>
                        <textarea id="leave-reason" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Submit Leave Request</button>
                    <p id="leave-request-message" class="mt-2 text-sm text-center" style="display: none;"></p>
                </form>
            </div>

            <!-- Column 4: My Leave Requests -->
            <div class="card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <i data-lucide="clock" class="w-5 h-5 mr-2 text-blue-600"></i>
                    My Leave Status
                </h2>
                <div id="leave-status-container" class="space-y-3">
                    <p class="text-gray-500">No pending or recent leave requests found.</p>
                </div>
            </div>
        </section>
        
        <!-- Column 5: Issue Reporting and Tracking (Existing, now streamlined) -->
        <section class="lg:col-span-3 card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i data-lucide="hammer" class="w-5 h-5 mr-2 text-orange-600"></i>
                Maintenance & Issue Reporting
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Issue Reporting Form -->
                <div class="md:col-span-1 space-y-4">
                    <h3 class="text-lg font-medium text-gray-700">Report New Issue</h3>
                    <select id="issue-type" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="Plumbing">Plumbing Leak/Blockage</option>
                        <option value="Electrical">Electrical Failure/Fault</option>
                        <option value="Furniture">Furniture Damage (Bed, Chair, Table)</option>
                        <option value="Sanitation">Sanitation/Cleaning Required</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="issue-location" placeholder="Room/Block Number (e.g., A-305)" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    <textarea id="issue-description" rows="3" placeholder="Detailed description of the problem..." class="w-full p-2 border border-gray-300 rounded-lg" required></textarea>
                    <button onclick="submitIssueReport()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Submit Report</button>
                    <p id="issue-report-message" class="mt-2 text-sm text-center" style="display: none;"></p>
                </div>

                <!-- Issue Tracking List -->
                <div class="md:col-span-2">
                    <h3 class="text-lg font-medium text-gray-700">My Reported Issues</h3>
                    <div id="issue-tracking-list" class="space-y-3 mt-3">
                        <p class="text-gray-500">Loading issues...</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level to Debug
        setLogLevel('Debug');

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        let userName = "Anonymous User"; // Placeholder name

        // Global configuration variables (MUST be used)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-hostel-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Utility Functions ---
        function getCollectionPath(type, uid = null) {
            switch(type) {
                case 'mess_menu':
                    return `artifacts/${appId}/public/data/mess_menu`;
                case 'notices':
                    return `artifacts/${appId}/public/data/notices`;
                case 'leave_requests':
                case 'issues':
                case 'feedback':
                    return `artifacts/${appId}/users/${uid || userId}/${type}`;
                default:
                    console.error("Unknown collection type:", type);
                    return null;
            }
        }
        
        function getTodayDateId() {
            return new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
        }

        // --- Firebase Initialization and Auth ---
        window.onload = async function() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign-in logic
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            // Display full user ID as required for multi-user apps
                            document.getElementById('user-id-display').textContent = userId;
                            document.getElementById('loading-overlay').style.display = 'none';

                            // Start listeners after authentication is ready
                            startDataListeners();
                        } else {
                            // Should not happen if signInAnonymously is successful, but handle logout/error
                            userId = null;
                            document.getElementById('user-id-display').textContent = 'Error/Signed Out';
                            document.getElementById('loading-overlay').style.display = 'none';
                        }
                        // Re-initialize icons
                        lucide.createIcons();
                    });

                } else {
                    console.error("Firebase config is missing or invalid.");
                    document.getElementById('loading-overlay').innerHTML = '<p class="text-red-600">Configuration Error: Firebase setup failed.</p>';
                }
            } catch (error) {
                console.error("Error during Firebase initialization:", error);
                document.getElementById('loading-overlay').innerHTML = '<p class="text-red-600">Initialization Error: Check console for details.</p>';
            }
        };

        // --- Data Listeners ---
        function startDataListeners() {
            if (!db || !userId) return;

            // 1. Mess Menu Listener (Public Data)
            const todayDateId = getTodayDateId();
            const menuDocRef = doc(db, getCollectionPath('mess_menu'), todayDateId);
            onSnapshot(menuDocRef, (docSnap) => {
                const menuData = docSnap.exists() ? docSnap.data().meals : null;
                renderMessMenu(menuData);
            }, (error) => {
                console.error("Error fetching menu:", error);
                renderMessMenu(null);
            });

            // 2. Notices Listener (Public Data)
            const noticesQuery = query(collection(db, getCollectionPath('notices')));
            onSnapshot(noticesQuery, (snapshot) => {
                const notices = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderNotices(notices.sort((a, b) => b.timestamp - a.timestamp)); // Sort newest first
            }, (error) => {
                console.error("Error fetching notices:", error);
                document.getElementById('notices-container').innerHTML = '<p class="text-red-500">Failed to load notices.</p>';
            });

            // 3. My Issues Listener (Private Data)
            const issuesQuery = query(collection(db, getCollectionPath('issues')), where("userId", "==", userId));
            onSnapshot(issuesQuery, (snapshot) => {
                const issues = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderIssueTracking(issues.sort((a, b) => b.timestamp - a.timestamp)); // Sort newest first
            }, (error) => {
                console.error("Error fetching issues:", error);
                document.getElementById('issue-tracking-list').innerHTML = '<p class="text-red-500">Failed to load issues.</p>';
            });

            // 4. My Leave Requests Listener (Private Data)
            const leaveQuery = query(collection(db, getCollectionPath('leave_requests')), where("userId", "==", userId));
            onSnapshot(leaveQuery, (snapshot) => {
                const requests = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderLeaveRequests(requests.sort((a, b) => b.timestamp - a.timestamp)); // Sort newest first
            }, (error) => {
                console.error("Error fetching leave requests:", error);
                document.getElementById('leave-status-container').innerHTML = '<p class="text-red-500">Failed to load leave requests.</p>';
            });
        }

        // --- UI Rendering Functions ---

        // Renders the 4-meal menu data and sets up tabs
        function renderMessMenu(data) {
            const container = document.getElementById('menu-tabs-content');
            container.innerHTML = '';
            const meals = ["Breakfast", "Lunch", "Snack", "Dinner"];

            if (!data) {
                container.innerHTML = `<p class="text-gray-600 mt-4 p-4 bg-red-50 rounded-lg">Mess menu not set for today (${getTodayDateId()}).</p>`;
                return;
            }

            meals.forEach((mealType, index) => {
                const mealData = data[mealType] || { items: ["Menu not available."], feedback: 0 };
                const isActive = index === 0 ? 'active' : '';
                const ratingDisplay = mealData.feedback > 0 
                    ? `<span class="font-bold text-yellow-600">${mealData.feedback.toFixed(1)}/5.0</span>`
                    : `<span class="text-gray-400">No feedback yet.</span>`;

                container.innerHTML += `
                    <div id="meal-${mealType}" class="tab-content ${isActive}">
                        <p class="text-sm text-gray-500 mb-2">Average Rating: ${ratingDisplay}</p>
                        <ul class="list-disc list-inside space-y-1 text-gray-700 p-3 bg-gray-50 rounded-lg">
                            ${mealData.items.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });

            // Set up tab switching logic
            document.querySelectorAll('.tab-button').forEach(button => {
                button.onclick = () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                    button.classList.add('active');
                    document.getElementById(`meal-${button.dataset.meal}`).classList.add('active');

                    // Sync feedback form selector
                    document.getElementById('feedback-meal-type').value = button.dataset.meal;
                };
            });
        }

        // Renders the Notice Board
        function renderNotices(notices) {
            const container = document.getElementById('notices-container');
            if (notices.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No official announcements currently posted.</p>';
                return;
            }

            container.innerHTML = notices.map(notice => {
                const urgencyClass = notice.isUrgent ? 'bg-red-100 border-red-400 text-red-800' : 'bg-blue-100 border-blue-400 text-blue-800';
                const date = notice.timestamp ? new Date(notice.timestamp.toDate()).toLocaleDateString() : 'N/A';
                
                return `
                    <div class="p-4 border-l-4 ${urgencyClass} rounded-lg">
                        <p class="font-semibold">${notice.title}</p>
                        <p class="text-sm mt-1">${notice.content}</p>
                        <p class="text-xs text-gray-600 mt-2">Posted on: ${date}</p>
                    </div>
                `;
            }).join('');
        }

        // Renders the Leave Requests list
        function renderLeaveRequests(requests) {
            const container = document.getElementById('leave-status-container');
            if (requests.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No pending or recent leave requests found.</p>';
                return;
            }

            container.innerHTML = requests.map(req => {
                let statusClass = '';
                if (req.status === 'Approved') statusClass = 'text-green-600 bg-green-50';
                else if (req.status === 'Rejected') statusClass = 'text-red-600 bg-red-50';
                else statusClass = 'text-yellow-600 bg-yellow-50';
                
                const dateRange = `${req.startDate} to ${req.endDate}`;
                const date = req.timestamp ? new Date(req.timestamp.toDate()).toLocaleDateString() : 'N/A';

                return `
                    <div class="p-3 border rounded-lg ${statusClass}">
                        <div class="flex justify-between items-start">
                            <p class="font-semibold">Reason: ${req.reason.substring(0, 30)}...</p>
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${statusClass.replace('-600', '-800').replace('-50', '-100')}">${req.status}</span>
                        </div>
                        <p class="text-sm text-gray-700 mt-1">Dates: ${dateRange}</p>
                        <p class="text-xs text-gray-500 mt-1">Submitted: ${date}</p>
                    </div>
                `;
            }).join('');
        }
        
        // Renders the Issue Tracking list
        function renderIssueTracking(issues) {
            const container = document.getElementById('issue-tracking-list');
            if (issues.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No issues reported yet. All clear!</p>';
                return;
            }

            container.innerHTML = issues.map(issue => {
                let statusColor = '';
                if (issue.status === 'Resolved') statusColor = 'bg-green-200 text-green-800';
                else if (issue.status === 'In Progress') statusColor = 'bg-yellow-200 text-yellow-800';
                else statusColor = 'bg-red-200 text-red-800';

                const date = issue.timestamp ? new Date(issue.timestamp.toDate()).toLocaleDateString() : 'N/A';

                return `
                    <div class="p-3 border border-gray-200 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">${issue.type} - ${issue.location}</p>
                            <p class="text-sm text-gray-600 truncate max-w-xs">${issue.description}</p>
                            <p class="text-xs text-gray-500 mt-1">Reported: ${date}</p>
                        </div>
                        <span class="text-xs font-medium px-3 py-1 rounded-full ${statusColor}">${issue.status}</span>
                    </div>
                `;
            }).join('');
        }

        // --- Core Action Functions ---

        // 1. Submit Mess Feedback
        window.submitMessFeedback = async function() {
            const mealType = document.getElementById('feedback-meal-type').value;
            const rating = parseFloat(document.getElementById('rating-input').value);
            const feedbackMsg = document.getElementById('feedback-message');
            feedbackMsg.style.display = 'block';

            if (!rating || rating < 1 || rating > 5) {
                feedbackMsg.className = 'mt-2 text-sm text-center text-red-500';
                feedbackMsg.textContent = "Please provide a valid rating between 1 and 5.";
                return;
            }
            if (!db || !userId) {
                feedbackMsg.className = 'mt-2 text-sm text-center text-red-500';
                feedbackMsg.textContent = "Error: Not connected to the database. Please reload.";
                return;
            }

            try {
                // Submit feedback as a private document
                await addDoc(collection(db, getCollectionPath('feedback')), {
                    userId: userId,
                    mealType: mealType,
                    rating: rating,
                    timestamp: serverTimestamp()
                });

                feedbackMsg.className = 'mt-2 text-sm text-center text-green-600';
                feedbackMsg.textContent = `Thank you! Your ${mealType} feedback has been recorded.`;
                document.getElementById('rating-input').value = '';

                // Note: The UI for average rating relies on a separate process (admin/backend) 
                // to aggregate this feedback and update the main menu document. 
                // We show the success message to the user immediately.
            } catch (e) {
                console.error("Error submitting feedback: ", e);
                feedbackMsg.className = 'mt-2 text-sm text-center text-red-500';
                feedbackMsg.textContent = "Submission failed. Please try again.";
            }
            setTimeout(() => { feedbackMsg.style.display = 'none'; }, 5000);
        }

        // 2. Submit Leave Request
        document.getElementById('leave-request-form').onsubmit = async function(e) {
            e.preventDefault();
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const reason = document.getElementById('leave-reason').value;
            const requestMsg = document.getElementById('leave-request-message');
            requestMsg.style.display = 'block';

            if (!db || !userId) {
                requestMsg.className = 'mt-2 text-sm text-center text-red-500';
                requestMsg.textContent = "Error: Not connected to the database. Please reload.";
                return;
            }

            try {
                await addDoc(collection(db, getCollectionPath('leave_requests')), {
                    userId: userId,
                    userName: userName, // Using placeholder name
                    startDate: startDate,
                    endDate: endDate,
                    reason: reason,
                    status: "Pending", // Initial status
                    timestamp: serverTimestamp()
                });

                requestMsg.className = 'mt-2 text-sm text-center text-green-600';
                requestMsg.textContent = "Leave request submitted successfully! Check status on the right.";
                document.getElementById('leave-request-form').reset();
            } catch (e) {
                console.error("Error submitting leave request: ", e);
                requestMsg.className = 'mt-2 text-sm text-center text-red-500';
                requestMsg.textContent = "Submission failed. Please try again.";
            }
            setTimeout(() => { requestMsg.style.display = 'none'; }, 5000);
        };
        
        // 3. Submit Issue Report (Existing Feature)
        window.submitIssueReport = async function() {
            const type = document.getElementById('issue-type').value;
            const location = document.getElementById('issue-location').value.trim();
            const description = document.getElementById('issue-description').value.trim();
            const issueMsg = document.getElementById('issue-report-message');
            issueMsg.style.display = 'block';

            if (!location || !description) {
                issueMsg.className = 'mt-2 text-sm text-center text-red-500';
                issueMsg.textContent = "Location and description are required.";
                return;
            }
            if (!db || !userId) {
                issueMsg.className = 'mt-2 text-sm text-center text-red-500';
                issueMsg.textContent = "Error: Not connected to the database. Please reload.";
                return;
            }

            try {
                await addDoc(collection(db, getCollectionPath('issues')), {
                    userId: userId,
                    type: type,
                    location: location,
                    description: description,
                    status: "Reported", // Initial status
                    timestamp: serverTimestamp()
                });

                issueMsg.className = 'mt-2 text-sm text-center text-green-600';
                issueMsg.textContent = "Maintenance report submitted! We'll get right on it.";
                document.getElementById('issue-location').value = '';
                document.getElementById('issue-description').value = '';
            } catch (e) {
                console.error("Error submitting issue report: ", e);
                issueMsg.className = 'mt-2 text-sm text-center text-red-500';
                issueMsg.textContent = "Submission failed. Please try again.";
            }
            setTimeout(() => { issueMsg.style.display = 'none'; }, 5000);
        }

        // --- Demo/Placeholder Setup (For initial testing) ---
        // This function adds a placeholder menu and notice if none exists, to show the features work instantly.
        window.setupPlaceholders = async function() {
            if (!db) return;
            const todayDateId = getTodayDateId();
            const menuDocRef = doc(db, getCollectionPath('mess_menu'), todayDateId);

            // 1. Create Placeholder Menu (if missing)
            await setDoc(menuDocRef, {
                date: todayDateId,
                meals: {
                    Breakfast: { items: ["Bread Omelette", "Tea", "Juice"], feedback: 4.5 },
                    Lunch: { items: ["Rice, Dal, Seasonal Veg", "Salad"], feedback: 4.2 },
                    Snack: { items: ["Samosa & Chatni", "Coffee"], feedback: 4.0 },
                    Dinner: { items: ["Chicken/Paneer Curry", "Roti, Rice", "Dessert"], feedback: 4.7 }
                }
            }, { merge: true }).catch(e => console.error("Error creating menu placeholder:", e));

            // 2. Create Placeholder Notice (if missing)
            const noticesCollectionRef = collection(db, getCollectionPath('notices'));
            const noticeTitle = "Holiday Gate Hours Notice";
            // Check if a notice with this title already exists to prevent spamming
            // Note: In a real app, you'd query by title, but here we simply try to add.
             await addDoc(noticesCollectionRef, {
                timestamp: serverTimestamp(),
                title: noticeTitle,
                content: "The main gate will remain open until 11:30 PM this Saturday for the festival. All residents must report by then.",
                author: "Warden's Office",
                isUrgent: true
            }).catch(() => {/* Ignore if already exists (best effort) */});

        };
        // Run placeholder setup immediately after auth is confirmed
        onAuthStateChanged(auth, (user) => {
             if (user) {
                // Give a small delay to ensure listeners are set before running placeholders
                setTimeout(setupPlaceholders, 1000);
            }
        });
        
    </script>
</body>
</html>
